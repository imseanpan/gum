<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gum.SASS template page</title>

    <!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Include the compiled Gum.SASS CSS -->
    <link href="../../gum.ui.sass/gum.css" rel="stylesheet">
    <!--<link href="../../gum.ui/toggles/toggles.js" rel="stylesheet">-->
</head>
<!--ontouchstart 解决IOS内不能点击的问题-->
<body>

<!-- Make sure all your bars are the first things in your <body> -->
<header class="bar bar-nav">
    <h1 class="title">列表</h1>
</header>

<!-- Wrap all non-bar HTML in the .content div (this is actually what scrolls) -->
<div class="content">
    <div style="height:40px;"></div>
    <ul class="table-view">
        <li class="table-view-cell">
            Item 1
            <div class="toggle">
                <div class="toggle-handle"></div>
            </div>
        </li>
        <li class="table-view-cell">
            Item 2
            <div class="toggle active">
                <div class="toggle-handle"></div>
            </div>
        </li>
        <li class="table-view-cell">
            Item 3
            <div class="toggle">
                <div class="toggle-handle"></div>
            </div>
        </li>
    </ul>

</div>
<script>

    !(function () {
        'use strict';

        var start     = {};
        var touchMove = false;
        var distanceX = false;
        var toggle    = false;

        var findToggle = function (target) {
            var i;
            var toggles = document.querySelectorAll('.toggle');

            for (; target && target !== document; target = target.parentNode) {
                for (i = toggles.length; i--;) {
                    if (toggles[i] === target) {
                        return target;
                    }
                }
            }
        };

        window.addEventListener('touchstart', function (e) {
            e = e.originalEvent || e;

            toggle = findToggle(e.target);

            if (!toggle) {
                return;
            }

            var handle      = toggle.querySelector('.toggle-handle');
            var toggleWidth = toggle.clientWidth;
            var handleWidth = handle.clientWidth;
            var offset      = toggle.classList.contains('active') ? (toggleWidth - handleWidth) : 0;

            start     = { pageX : e.touches[0].pageX - offset, pageY : e.touches[0].pageY };
            touchMove = false;
        });

        window.addEventListener('touchmove', function (e) {
            e = e.originalEvent || e;

            if (e.touches.length > 1) {
                return; // Exit if a pinch
            }

            if (!toggle) {
                return;
            }

            var handle      = toggle.querySelector('.toggle-handle');
            var current     = e.touches[0];
            var toggleWidth = toggle.clientWidth;
            var handleWidth = handle.clientWidth;
            var offset      = toggleWidth - handleWidth;

            touchMove = true;
            distanceX = current.pageX - start.pageX;

            if (Math.abs(distanceX) < Math.abs(current.pageY - start.pageY)) {
                return;
            }

            e.preventDefault();

            if (distanceX < 0) {
                return (handle.style.webkitTransform = 'translate3d(0,0,0)');
            }
            if (distanceX > offset) {
                return (handle.style.webkitTransform = 'translate3d(' + offset + 'px,0,0)');
            }

            handle.style.webkitTransform = 'translate3d(' + distanceX + 'px,0,0)';

            toggle.classList[(distanceX > (toggleWidth / 2 - handleWidth / 2)) ? 'add' : 'remove']('active');
        });

        window.addEventListener('touchend', function (e) {
            if (!toggle) {
                return;
            }

            var handle      = toggle.querySelector('.toggle-handle');
            var toggleWidth = toggle.clientWidth;
            var handleWidth = handle.clientWidth;
            var offset      = (toggleWidth - handleWidth);
            var slideOn     = (!touchMove && !toggle.classList.contains('active')) || (touchMove && (distanceX > (toggleWidth / 2 - handleWidth / 2)));

            if (slideOn) {
                handle.style.webkitTransform = 'translate3d(' + offset + 'px,0,0)';
            } else {
                handle.style.webkitTransform = 'translate3d(0,0,0)';
            }

            toggle.classList[slideOn ? 'add' : 'remove']('active');

            e = new CustomEvent('toggle', {
                detail: { isActive: slideOn },
                bubbles: true,
                cancelable: true
            });

            toggle.dispatchEvent(e);

            touchMove = false;
            toggle    = false;
        });

    }());

</script>
</body>
</html>

